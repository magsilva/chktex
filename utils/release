#!/bin/sh

PROJ=chktex
VERSION=$1
DIR=files/$PROJ.pkg/$VERSION/
TAG=version-$VERSION
TAGFILE=file:///home/svn/$PROJ/tags/$PROJ/$TAG
DOLINK=0

if [ -z "$VERSION" ]
then
	echo "No version given."
	exit 1
fi

if [ "$VERSION" = "snapshot" ]
then
	echo "Doing snapshot"
	DOLINK=1
	VERSION=snapshot-`date +%Y.%m.%d`
	TAGFILE=file:///home/svn/$PROJ/trunk/$PROJ
	DIR=files/$PROJ.pkg/snapshot
	rm -f $DIR/*
fi

FILE=$PROJ-$VERSION.tar.gz
BASEDIR=$PROJ-$VERSION/

if [ $DOLINK ]
then
	ln -s $FILE $DIR/websec-snapshot.tar.gz
fi

# Export clean copy of the repository
svn export $TAGFILE $BASEDIR
if [ $? != 0 ]
then
	echo "Error while checking out the version."
	rm -rf $BASEDIR
	exit 1
fi

# Prepare version for release
if [ -f $BASEDIR/autogen.sh ]
then
	pushd $BASEDIR
	./autogen.sh
	popd
elif [ -f $BASEDIR/Makefile ]
then
	pushd $BASEDIR
	make
	popd
fi

# Generate ChangeLog
#utils/extractNEWS $BASEDIR/NEWS > $DIR/ChangeLog

# Create tar.gz file
tar cvzf $FILE $BASEDIR
mkdir $DIR
mv $FILE $DIR
rm -rf $BASEDIR

# Sign the tar.gz
echo "Now we GPG sign the release:"
pushd $DIR
gpg --detach --armor --sign $FILE
popd

# Locally update the site
utils/update
